// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id                    Int                     @id @default(autoincrement())
  nombre                String
  username              String                  @unique
  password              String
  rol                   String                  // 'Administrador' o 'Vendedor'
  ventas                Venta[]
  movimientos_inventario MovimientoInventario[]
  cierres_caja          CierreCaja[]

  @@map("usuarios")
}

model Cliente {
  id     Int     @id @default(autoincrement())
  nombre String  @unique
  ventas Venta[]

  @@map("clientes")
}

model Producto {
  id                    Int                     @id @default(autoincrement())
  nombre                String                  @unique
  precio                Decimal                 @db.Decimal(10, 2) @default(0)
  detalleVentas         DetalleVenta[]
  almacenamiento        Almacenamiento?
  alertas_stock         AlertaStock[]
  movimientos_inventario MovimientoInventario[]

  @@map("productos")
}

model Almacenamiento {
  id                    Int                     @id @default(autoincrement())
  producto_id           Int                     @unique
  stock                 Int                     @default(0)
  stock_minimo          Int                     @default(5)
  codigo_barras         String?                 @unique
  fecha_creacion        DateTime                @default(now())
  fecha_actualizacion   DateTime                @default(now()) @updatedAt
  producto              Producto                @relation(fields: [producto_id], references: [id], onDelete: Cascade)
  alertas_stock         AlertaStock[]
  movimientos_inventario MovimientoInventario[]

  @@index([producto_id])
  @@index([stock])
  @@index([codigo_barras])
  @@map("almacenamiento")
}

model AlertaStock {
  id                    Int                     @id @default(autoincrement())
  almacenamiento_id     Int
  producto_id           Int
  tipo_alerta           String                  @default("STOCK_BAJO")
  stock_actual          Int
  stock_minimo          Int
  estado                String                  @default("ACTIVA")
  fecha_creacion        DateTime                @default(now())
  fecha_resolucion      DateTime?
  almacenamiento        Almacenamiento          @relation(fields: [almacenamiento_id], references: [id], onDelete: Cascade)
  producto              Producto                @relation(fields: [producto_id], references: [id], onDelete: Cascade)

  @@index([almacenamiento_id])
  @@index([producto_id])
  @@index([estado])
  @@index([fecha_creacion])
  @@map("alertas_stock")
}

model MovimientoInventario {
  id                    Int                     @id @default(autoincrement())
  almacenamiento_id     Int
  producto_id           Int
  tipo_movimiento       String                  // 'ENTRADA', 'SALIDA', 'AJUSTE'
  cantidad              Int
  stock_anterior        Int
  stock_nuevo           Int
  referencia_venta_id   Int?
  descripcion           String?                 @db.Text
  usuario_id            Int?
  fecha_movimiento      DateTime                @default(now())
  almacenamiento        Almacenamiento          @relation(fields: [almacenamiento_id], references: [id], onDelete: Cascade)
  producto              Producto                @relation(fields: [producto_id], references: [id], onDelete: Cascade)
  usuario               Usuario?                @relation(fields: [usuario_id], references: [id], onDelete: SetNull)

  @@index([almacenamiento_id])
  @@index([producto_id])
  @@index([tipo_movimiento])
  @@index([fecha_movimiento])
  @@index([referencia_venta_id])
  @@map("movimientos_inventario")
}

model Venta {
  id           Int            @id @default(autoincrement())
  cliente      String
  cliente_id   Int?
  productos    String         @db.Text
  precio_total Decimal        @db.Decimal(10, 2)
  metodo_pago  String
  fecha_venta  DateTime       @default(now())
  usuario_id   Int?
  clienteRel   Cliente?       @relation(fields: [cliente_id], references: [id])
  usuarioRel   Usuario?       @relation(fields: [usuario_id], references: [id])
  detalles     DetalleVenta[]
  comprobante  ComprobanteElectronico?

  // ✅ ÍNDICES OPTIMIZADOS PARA REPORTES
  // Índice para filtros por fecha (CRÍTICO)
  @@index([fecha_venta])
  
  // Índice para filtros por método de pago
  @@index([metodo_pago])
  
  // Índice para búsqueda por cliente
  @@index([cliente])
  
  // Índice compuesto para queries comunes
  @@index([fecha_venta, metodo_pago])
  
  // Índice compuesto para ordenamiento
  @@index([fecha_venta, precio_total])

  @@map("ventas")
}

model DetalleVenta {
  id          Int      @id @default(autoincrement())
  venta_id    Int
  producto_id Int?
  producto    String
  cantidad    Int
  precio      Decimal  @db.Decimal(10, 2)
  venta       Venta    @relation(fields: [venta_id], references: [id], onDelete: Cascade)
  productoRel Producto? @relation(fields: [producto_id], references: [id])

  @@map("detalle_venta")
}

model ComprobanteElectronico {
  id                Int       @id @default(autoincrement())
  venta_id          Int       @unique
  tipo              String    // 'FACTURA' o 'BOLETA'
  serie             String    // Ej: F001, B001
  numero            Int       // Número correlativo
  xmlSinFirma       String    @db.LongText
  xmlFirmado        String?   @db.LongText
  cdrXml            String?   @db.LongText
  hashCpe           String?   // Hash del comprobante
  estado            String    @default("PENDIENTE") // PENDIENTE, ACEPTADO, RECHAZADO, ENVIADO
  codigoSunat       String?   // Código de respuesta SUNAT
  mensajeSunat      String?   @db.Text // Mensaje de respuesta SUNAT
  fechaEnvio        DateTime?
  fechaRespuesta    DateTime?
  intentosEnvio     Int       @default(0)
  ultimoError       String?   @db.Text
  venta             Venta     @relation(fields: [venta_id], references: [id], onDelete: Cascade)
  fecha_creacion    DateTime  @default(now())
  fecha_actualizacion DateTime @default(now()) @updatedAt

  @@index([venta_id])
  @@index([estado])
  @@index([fecha_creacion])
  @@index([serie, numero])
  @@map("comprobantes_electronicos")
}

model CierreCaja {
  id                Int      @id @default(autoincrement())
  usuario_id        Int
  fecha_apertura    DateTime @default(now())
  fecha_cierre      DateTime?
  estado            String   @default("ABIERTO") // ABIERTO | CERRADO

  monto_inicial     Decimal  @db.Decimal(10, 2) @default(0)
  monto_final       Decimal  @db.Decimal(10, 2) @default(0)
  total_ventas      Decimal  @db.Decimal(12, 2) @default(0)
  total_efectivo    Decimal  @db.Decimal(12, 2) @default(0)
  total_yape        Decimal  @db.Decimal(12, 2) @default(0)
  total_plin        Decimal  @db.Decimal(12, 2) @default(0)
  total_tarjeta     Decimal  @db.Decimal(12, 2) @default(0)
  total_transferencia Decimal @db.Decimal(12, 2) @default(0)
  total_otro        Decimal  @db.Decimal(12, 2) @default(0)

  total_anulaciones Decimal  @db.Decimal(12, 2) @default(0)
  total_descuentos  Decimal  @db.Decimal(12, 2) @default(0)
  observaciones     String?  @db.Text

  usuario           Usuario  @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@index([usuario_id])
  @@index([estado])
  @@index([fecha_apertura])
  @@index([fecha_cierre])
  @@map("cierres_caja")
}
